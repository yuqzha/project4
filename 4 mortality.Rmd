---
title: "4 mortality"
author: "Yuqi Zhang"
date: "2025-04-26"
output: html_document
---
To estimate the HR of BC death associated with factors (some from cohort1, and mammogram-related factors from cohort 2)
Strata: IntCa or ScrCa
factors: factors1 from cohort1, factors2 from cohort
adjustment: age, additionally TC

steps:
1.set up the data (define outcome and time: death_BC, time_var, factors)
2.model cohort 1 and 2 separately

note: 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(survival)
library(survminer)
library(ggplot2)
library(purrr)
library(splines)
library(haven) # to handle haven_labelled variables
```

```{r}
load("data/cohorts.RData")
```

## define outcome: BC-specific death
```{r}
cohort1 <- cohort1 |> 
  mutate(
         time_start = diadat, # enter at diagnosis
         time_end = ymd("2022-12-31"),
         time_to_death = as.numeric(death_date - time_start),
         time_to_emig = 
           case_when(
             emigration_last_date > time_start ~ as.numeric(emigration_last_date - time_start),
             TRUE ~ NA_real_),
         death_BC =  case_when(
           !is.na(death_date)  & substr(death_cause, 1,3) %in% c("C50", "174") ~ 1,
           # !is.na(death_date)  & substr(death_cause, 1,3) %in% c("C50", "174") & time_to_death <= 365*10 ~ 1, 
            # 10-year mortality
             TRUE ~ 0),
      # death_BC = ifelse(is.na(death_cause), 0, # for competing risk
         #                 ifelse(substr(death_cause, 1,3) %in% c("C50", "170"), 1, 2)),
         time_var = pmin(time_to_death, time_to_emig, time_end - time_start,na.rm=T)) #365*10
         

# cohort2 <- cohort2 |> 
#    mutate(
#          across(T_pad_c:HER2_positive, factor),
#          across(T_pad_c:HER2_positive, ~ {
#   # Add "Unknown" as a new level
#   levels(.) <- c(levels(.), "Unknown") ## careful 9 exists in some variables, and new category with same meaning generated
#   # Replace NAs with "Unknown"
#   .[is.na(.)] <- "Unknown"
#   return(.)
# }))
```

```{r}
# as of Aug 3 2025
factors1 <- c("year1","period", "parity","age_1st_child", "Education_2cat", "FH_BC_bl_50") 
tc <- c("T_pad_c",  "N_pad_positive", "ER_negative", "grade")
trt <- c("post_chemo", "post_radio") # post_endo

covariate1 <- "age_at_diagnosis"
covariate2 <- c("age_at_diagnosis", tc)
covariate3 <- c("age_at_diagnosis", tc, trt) 

# load function of coxph loop
source("FUN_coxph_loop.R")
```

# factors based on cohort 1
```{r}
# Convert columns to factors before analysis
cohort <- cohort1 %>%
  filter(M_stage != 1) |> 
  filter(insitu == 0) |> 
  mutate(across(all_of(c(factors1, tc, trt)), factor))

# Then run the analysis
cox0 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors1,
                   covariates = NULL,
                   group_var = "detection_mode")

# age adjusted
cox1 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors1,
                   covariates = covariate1,
                   group_var = "detection_mode")

# age and TC adjusted
cox2 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors1,
                   covariates = covariate2,
                   group_var = "detection_mode")

# age, TC and trt adjusted
cox3 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors1,
                   covariates = covariate3,
                   group_var = "detection_mode")
result1 <- cox0 |> 
  left_join(cox1, by = c("predictor_var","term","detection_mode"), suffix = c("","_age")) |> 
  left_join(cox2, by = c("predictor_var","term","detection_mode"), suffix = c("", "_tc")) |> 
  left_join(cox3, by = c("predictor_var","term","detection_mode"), suffix = c("", "_trt"))

temp1 <- result1[,c("predictor_var", "term", "detection_mode", "est_ci", "est_ci_age", "est_ci_tc","est_ci_trt")]
```

## cohort 2
```{r}
factors2 <- c("FH_BC_bl_40", "FH_BC_bl_50", "FH_BC_bl_median", "Breast_n_bi", "pd_BIRADs","bmi_cat", "hrt_ever","hrt_ever_reg","Alcohol_day", "smoking_packyears", "risk_breastcancer_own_5yr", "risk_breastcancer_own_10yr","risk_breastcancer_own_lifetime","GRS_BC", "protein_LOF_rare_variants_exonic", "pinkcat","BOADICEA") #pd_3group "masses_3cat","masses_dif_3cat","masses_dif", "smoking_status_dummy", "smoking_status_dummy2",

## as of Aug 3
factors2 <- c("FH_BC_bl_40", "FH_BC_bl_50", "FH_BC_bl_median", "Breast_n_bi", "pd_3group","pd_BIRADs","bmi_cat", "Alcohol_day", "smoking_packyears", "risk_breastcancer_own_10yr","GRS_BC", "protein_LOF_rare_variants_exonic", "pinkcat","BOADICEA")

# Convert columns to factors before analysis
cohort <- cohort2 |> 
 # filter(pd <= 40) |> 
 filter(cohort == "libro1" | (cohort == "karma" & bc_diagdate >= ymd("2005-01-01") & bc_diagdate <= ymd("2022-05-07"))) |>
  filter(detection_mode %in% c(1,2)) |> 
  filter(M_stage != 1) |> 
  filter(insitu != 1) |> 
  mutate(
    #time_start = pmax(bc_diagdate, studyentry_date), #delayed entry to start from study entry date or diagnosis date, whichever came later
    time_start = bc_diagdate, #no delay entry, enter at diagnosis
    time_end = ymd("2022-05-07"),
    time_to_death = as.numeric(death_date - time_start),
    # time_to_emig = 
    #   case_when(
    #     emigration_date > time_start ~ as.numeric(emigration_date - time_start),
    #   TRUE ~ NA_real_),
    death_BC =  case_when(
      !is.na(death_date)  & substr(death_cause, 1,3) %in% c("C50", "174") ~ 1,
      #!is.na(death_date)  & substr(death_cause, 1,3) %in% c("C50", "170") & time_to_death <= 365*10 ~ 1, # 10-year mortality
      TRUE ~ 0),
    time_var = pmin(time_to_death, time_end - time_start, na.rm=T), #365*10 time_to_emig, 
    detection_mode = factor(detection_mode, labels = c("ScrCa", "IntCa"))) 

# cohort <- cohort |> 
#   mutate(across(c(smoking_status_dummy, smoking_status_dummy2), factor))

cohort <- cohort |> 
   mutate(across(c(risk_breastcancer_own_10yr, GRS_BC), 
               ~ cut(., breaks = quantile(., probs = c(0, 0.25,0.50,0.75, 1), na.rm = TRUE), 
                    include.lowest = TRUE)))

# Then run the analysis
cox0 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors2,
                   covariates = NULL,
                   group_var = "detection_mode")

# age adjusted
cox1 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors2,
                   covariates = covariate1,
                   group_var = "detection_mode")

# age and TC adjusted
cox2 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors2,
                   covariates = covariate2,
                   group_var = "detection_mode")
# age, TC and trt adjusted
cox3 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors2,
                   covariates = covariate3,
                   group_var = "detection_mode")

result2 <- cox0 |> 
  left_join(cox1, by = c("predictor_var","term","detection_mode"), suffix = c("","_age")) |> 
  left_join(cox2, by = c("predictor_var","term","detection_mode"), suffix = c("", "_tc")) |> 
  left_join(cox3, by = c("predictor_var","term","detection_mode"), suffix = c("", "_trt"))

View(result2[,c("predictor_var", "term", "detection_mode", "est_ci", "est_ci_age", "est_ci_tc","est_ci_trt")])
```

```{r}
result <- bind_rows(result1, result2) |> 
  mutate(order = 1:42) |> 
  arrange(detection_mode, order)

output <- result |> 
  select(detection_mode, predictor_var, term, est_ci_age, p.value_age, est_ci_tc, p.value_tc)

write_csv(output, "HR_detection_mode_factors.csv")
```

```{r}
cohort %>% filter(!is.na(masses_3cat)) |> 
  count(detection_mode, masses_3cat) %>%
  group_by(detection_mode) %>%
  mutate(n_prop = sprintf("%d (%.1f%%)", n, n / sum(n) * 100)) %>%
  select(detection_mode, masses_3cat, n_prop)

cohort %>% filter(!is.na(masses_3cat) & !is.na(grade)) |> 
  count(masses_3cat, grade) %>%
  group_by(masses_3cat) %>%
  mutate(n_prop = sprintf("%d (%.1f%%)", n, n / sum(n) * 100)) %>%
  select(masses_3cat, grade, n_prop)
```
```{r}
cohort %>% filter(!is.na(masses_3cat) & !is.na(ER_negative)) |> 
  count(masses_3cat, ER_negative) %>%
  group_by(masses_3cat) %>%
  mutate(n_prop = sprintf("%d (%.1f%%)", n, n / sum(n) * 100)) %>%
  select(masses_3cat, ER_negative, n_prop)
```


## previous code
```{r}
cohort <- cohort1 |> 
  #filter(!(period == "1989-1999" & age_cat == "40-49")) |> 
  filter(detection_mode_1 == "IntCa") |> 
  mutate(
    Education_2cat = case_when(
      Education %in% c(1,2) ~ 1,
      Education == 3 ~ 3,
      TRUE ~ NA
    ),
    Education_2cat = factor(Education_2cat, levels = c(3,1))
  )

BC_surv <- Surv(time = cohort$time_var,
                event = cohort$death_BC)

surv_uni <- function(outcome, variable) { 
tidy(coxph(outcome ~ variable + age_at_diagnosis, data = cohort), 
     exponentiate = T, 
     conf.int = TRUE)
 }

surv_uni(BC_surv, cohort$year_since_screen)
surv_uni(BC_surv, cohort$FH_BC_bl_50)
surv_uni(BC_surv, cohort$FH_hboc_in_bl_50)
surv_uni(BC_surv, cohort$age_1st_child_20_25)
surv_uni(BC_surv, cohort$Education_2cat)
surv_uni(BC_surv, cohort$alcohol)
surv_uni(BC_surv, cohort$obesity)
surv_uni(BC_surv, cohort$parity)
surv_uni(BC_surv, cohort$age_1st_child)

surv_inc_tc <- function(outcome, variable) { 
tidy(coxph(outcome ~ variable + age_at_diagnosis + factor(T_pad_c) + factor(grade) + factor(N_pad_positive) , data = cohort),
     exponentiate = T, 
     conf.int = TRUE)
}

surv_inc_tc(BC_surv, cohort$year_since_screen)
surv_inc_tc(BC_surv, cohort$alcohol)
surv_inc_tc(BC_surv, cohort$obesity)
surv_inc_tc(BC_surv, cohort$FH_BC_bl_40)
surv_inc_tc(BC_surv, cohort$Education_2cat)
surv_inc_tc(BC_surv, cohort$age_1st_child)
```
```{r}
write_csv(cohort1, "cohort1.csv")
write_csv(cohort2, "cohort2.csv")
```

## cumhaz
```{r}
source("plot_cumulative_hazard.R")
two_color <- c("#1642BF", "#FAA31B")

p0 <- plot_cumulative_hazard(cohort, 
                            "time_var", "death_BC", 
                            detection_mode, 
                            xlim = c(0, 10), ylim = c(0, 0.2),
                            group_labels =c("ScrCa","IntCa"),
                            colors = two_color)
print(p0)

# Use with strata
# by period
cohort <- cohort |> 
  mutate(period = case_when(
    year >=1992 & year <2000 ~ 1,
    year >=2000 & year <2011 ~ 2,
    year >=2011 & year <=2023 ~ 3,
    TRUE ~ NA_real_),
    period = factor(period))

p1 <- plot_cumulative_hazard(cohort, 
                            "time_var", "death_BC", 
                            detection_mode, strata1 = period,
                            xlim = c(0, 10), ylim = c(0, 0.2),
                            group_labels =c("ScrCa","IntCa"),
                            colors = two_color)
print(p1)

## not plot period as strata but different linetypes
source("plot_cumulative_hazard_v2.R")

p1v2 <- plot_cumulative_hazard_v2(cohort, 
                            "time_var", "death_BC", 
                            detection_mode, strata1 = period,
                            xlim = c(0, 10), ylim = c(0, 0.2),
                            group_labels = c("ScrCa","IntCa"),
                            strata1_labels = c("1992-1999", "2000-2010", "2011-2023"),  # optional
                            colors = two_color,
                            linetypes = c("solid", "dashed", "dotted"))  # optional
print(p1v2)

# by age at diagnosis
p2 <- plot_cumulative_hazard(cohort, 
                            "time_var", "death_BC", 
                            detection_mode_1, strata1 = age_cat,
                            xlim = c(0, 10), ylim = c(0, 0.2),
                            group_labels =c("ScrCa","IntCa"),
                            colors = two_color)
print(p2)

## by period and age_cat
p3 <- plot_cumulative_hazard(cohort, 
                            "time_var", "death_BC", 
                            detection_mode_1, strata1 = age_cat, strata2 = period,
                            xlim = c(0, 10), ylim = c(0, 0.3),
                            group_labels =c("ScrCa","IntCa"),
                            colors = two_color)
print(p3)

p0 <- p0 + ggtitle("Cumulative BC mortality since diagnosis")
p1 <- p1 + ggtitle("By diagnosis period") 
p2 <- p2 + ggtitle("By age at diagnosis")
p3 <- p3 + ggtitle("By diagnosis period and age")
# combine using patchwork
library(patchwork)
cumhaz1 <- (p0 / p3) | (p1 / p2)
```

## cumhaz: start time from last screening date
```{r}
p0 <- plot_cumulative_hazard(cohort, 
                            "(outcome_date - as.numeric(x_Screening_ExaminationDate)) / 365", "death_BC", 
                            detection_mode_1, 
                            xlim = c(0, 10), ylim = c(0, 0.2),
                            group_labels =c("ScrCa","IntCa"),
                            colors = two_color)
print(p0)

# Use with strata
# by period
p1 <- plot_cumulative_hazard(cohort, 
                            "(outcome_date - as.numeric(x_Screening_ExaminationDate)) / 365", "death_BC", 
                            detection_mode_1, strata1 = period,
                            xlim = c(0, 10), ylim = c(0, 0.2),
                            group_labels =c("ScrCa","IntCa"),
                            colors = two_color)
print(p1)

# by age at diagnosis
p2 <- plot_cumulative_hazard(cohort, 
                            "(outcome_date - as.numeric(x_Screening_ExaminationDate)) / 365", "death_BC", 
                            detection_mode_1, strata1 = age_cat,
                            xlim = c(0, 10), ylim = c(0, 0.2),
                            group_labels =c("ScrCa","IntCa"),
                            colors = two_color)
print(p2)

## by period and age_cat
p3 <- plot_cumulative_hazard(cohort, 
                            "(outcome_date - as.numeric(x_Screening_ExaminationDate)) / 365", "death_BC", 
                            detection_mode_1, strata1 = age_cat, strata2 = period,
                            xlim = c(0, 10), ylim = c(0, 0.3),
                            group_labels =c("ScrCa","IntCa"),
                            colors = two_color)
print(p3)

p0 <- p0 + ggtitle("Cumulative BC mortality since last screening")
p1 <- p1 + ggtitle("By diagnosis period") 
p2 <- p2 + ggtitle("By age at diagnosis")
p3 <- p3 + ggtitle("By diagnosis period and age")
# combine using patchwork
library(patchwork)
cumhaz2 <- (p0 / p3) | (p1 / p2)
```

## competing risk: cmprsk
```{r}
library(cmprsk)
# Calculate CIF
cif_result <- cuminc(ftime = cohort$time_var, 
                     fstatus = cohort$death_BC,  # 0=censored, 1=BC death, 2=other death
                     group = cohort$detection_mode_1)

# Plot
plot(cif_result, 
     curvlab = c("ScrCa - BC death", "IntCa - BC death","ScrCa - other death", "IntCa - other death"),
     xlab = "Time", 
     ylab = "Cumulative Incidence")
```
## cumhaz by strata
```{r}
library(cmprsk)
library(purrr)
library(dplyr)
library(ggplot2)
library(broom)

# One-liner to get all CIF results
cohort_split <- cohort %>%
  split(.$age_cat)   # Split by strata

cif_all <-   map_dfr(~ {
    cif_result <- cuminc(ftime = .x$time_var,
                         fstatus = .x$death_BC,
                         group = .x$detection_mode_1)
    tidy(cif_result)
  }, .id = "age_cat")

# Plot with facets
cif_all %>%
  filter(outcome == 1) %>%  # BC deaths only
  ggplot(aes(x = time, y = estimate, color = strata)) +
  geom_step() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = strata), 
              alpha = 0.2) +
  facet_wrap(~ strata_var, scales = "free") +
  labs(x = "Time", 
       y = "Cumulative Incidence of BC Death") +
  theme_minimal() +
  theme(legend.position = "bottom")
```
```{r}
library(cmprsk)
library(purrr)
library(dplyr)
library(broom)

# Create a safe version of our function
safe_cuminc <- possibly(function(data) {
  if(nrow(data) < 2 || sum(data$death_BC > 0) == 0) {
    return(NULL)
  }
  
  cif_result <- cuminc(ftime = data$time_var,
                      fstatus = data$death_BC,
                      group = data$detection_mode_1)
  
  return(tidy(cif_result))
}, otherwise = NULL)

# Apply to split data
cif_all <- cohort %>%
  filter(!is.na(time_var), !is.na(death_BC), !is.na(detection_mode_1)) %>%
  split(.$age_cat) %>%
  map(safe_cuminc) %>%
  # Remove NULL results
  discard(is.null) %>%
  # Add age category names and combine
  imap_dfr(~ .x %>% mutate(age_cat = .y))
   
```

## univariable Cox
```{r}
surv_uni <- function(outcome, variable) { 
summary(coxph(outcome ~ variable + age_at_diagnosis , data = cohort))
 }
```

```{r}

surv_uni(BC_surv, cohort$Education_lisa)
surv_uni(BC_surv, cohort$pd_3group)
surv_uni(BC_surv, cohort$bmi_2cat)
surv_uni(BC_surv, cohort$age_1st_child)
surv_uni(BC_surv, cohort$calcs_bi)
surv_uni(BC_surv, cohort$masses_bi)
```

### stratified analysis
```{r}
# Stratified Cox model - assumes proportional hazards within strata
# but allows different baseline hazards for each stratum
model_stratified <- coxph(BC_surv ~ bmi_2cat + age_at_diagnosis + strata(pd_3group), 
                         data = cohort)
summary(model_stratified)

model_stratified <- coxph(BC_surv ~ pd_3group + age_at_diagnosis + strata(bmi_2cat), 
                         data = cohort)
summary(model_stratified)
```

### adjusting for TC
```{r}
surv_inc_tc <- function(outcome, variable) { 
summary(coxph(outcome ~ variable + age_at_diagnosis + T_pad_c + N_pad_positive + grade, data = cohort))
}
surv_inc_tc(BC_surv, cohort$bmi_cat)
surv_inc_tc(BC_surv, cohort$pd_3group)
surv_inc_tc(BC_surv, cohort$calcs_bi)
surv_inc_tc(BC_surv, cohort$masses_bi)
```
```{r}
surv_inc_tc(BC_surv, cohort$bmi_cat)
```

```{r}
# Assuming your data is called 'data' and pd_3group has 3 levels
# Fit separate models for each density group
model_bmi1 <- coxph(Surv(outcome_date - as.numeric(diadat),death_BC) ~ pd_2group + age_at_diagnosis, 
                          data = subset(cohort, bmi_2cat == "[0,25]"))
model_bmi2 <- coxph(Surv(outcome_date - as.numeric(diadat),death_BC) ~ pd_2group + age_at_diagnosis, 
                          data = subset(cohort, bmi_2cat == "(25,55]"))


# View results
summary(model_bmi1)
summary(model_bmi2)

```

```{r}
# Assuming your data is called 'data' and pd_3group has 3 levels
# Fit separate models for each density group
model_pd1 <- coxph(Surv(outcome_date - as.numeric(diadat),death_BC) ~ bmi_2cat + age_at_diagnosis, 
                          data = subset(cohort, pd_3group == "[0,20]"))
model_pd2 <- coxph(Surv(outcome_date - as.numeric(diadat),death_BC) ~ bmi_2cat + age_at_diagnosis, 
                          data = subset(cohort, pd_3group == "(20,40]"))
model_pd3 <- coxph(Surv(outcome_date - as.numeric(diadat),death_BC) ~ bmi_2cat + age_at_diagnosis, 
                          data = subset(cohort, pd_3group == "(40,100]"))


# View results
summary(model_pd1)


## pd 2 group
model_pd1 <- coxph(Surv(outcome_date - as.numeric(diadat),death_BC) ~ bmi_2cat + age_at_diagnosis, 
                          data = subset(cohort, pd_2group == "[0,20]"))
model_pd2 <- coxph(Surv(outcome_date - as.numeric(diadat),death_BC) ~ bmi_2cat + age_at_diagnosis, 
                          data = subset(cohort, pd_2group == "(20,100]"))

```

```{r}
summary(model_pd2)
```

```{r}
summary(model_pd3)
```

