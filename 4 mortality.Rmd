---
title: "4 mortality"
author: "Yuqi Zhang"
date: "2025-04-26"
output: html_document
---
To estimate the HR of BC death associated with factors (some from cohort1, and mammogram-related factors from cohort 2)
Strata: IntCa or ScrCa
factors: factors1 from cohort1, factors2 from cohort
adjustment: age, additionally TC

steps:
1.set up the data (define outcome and time: death_BC, time_var, factors)
2.model cohort 1 and 2 separately

note: 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(survival)
library(survminer)
library(ggplot2)
library(purrr)
library(splines)
library(haven) # to handle haven_labelled variables
```

```{r}
load("/Users/yuqzha/LIBRO1_BCSTO/IC_timing_prognosis/data/cohorts.RData")
```


## define outcome: BC-specific death
```{r}
cohort1 <- cohort1 |> 
  mutate(
         time_start = diadat, # enter at diagnosis
         time_end = ymd("2022-12-31"),
         time_to_death = as.numeric(death_date - time_start),
         time_to_emig = 
           case_when(
             emigration_last_date > time_start ~ as.numeric(emigration_last_date - time_start),
             TRUE ~ NA_real_),
         death_BC =  case_when(
           !is.na(death_date)  & substr(death_cause, 1,3) %in% c("C50", "174") ~ 1,
           # !is.na(death_date)  & substr(death_cause, 1,3) %in% c("C50", "174") & time_to_death <= 365*10 ~ 1, 
            # 10-year mortality
             TRUE ~ 0),
      # death_BC = ifelse(is.na(death_cause), 0, # for competing risk
         #                 ifelse(substr(death_cause, 1,3) %in% c("C50", "170"), 1, 2)),
         time_var = pmin(time_to_death, time_to_emig, time_end - time_start,na.rm=T)) #365*10
         

# cohort2 <- cohort2 |> 
#    mutate(
#          across(T_pad_c:HER2_positive, factor),
#          across(T_pad_c:HER2_positive, ~ {
#   # Add "Unknown" as a new level
#   levels(.) <- c(levels(.), "Unknown") ## careful 9 exists in some variables, and new category with same meaning generated
#   # Replace NAs with "Unknown"
#   .[is.na(.)] <- "Unknown"
#   return(.)
# }))
```

```{r}
# as of Aug 3 2025
factors1 <- c("year1","period", "parity","age_1st_child", "Education_2cat", "FH_BC_bl_50") 
tc <- c("T_pad_c",  "N_pad_positive", "ER_negative", "grade")
trt <- c("post_chemo", "post_radio","post_endo") # post_endo

covariate1 <- "age_at_diagnosis"
covariate2 <- c("age_at_diagnosis", tc)
covariate3 <- c("age_at_diagnosis", tc, trt) 

# load function of coxph loop
source("FUN_coxph_loop.R")
```

# factors based on cohort 1
```{r}
# Convert columns to factors before analysis
cohort <- cohort1 %>%
  filter(M_stage != 1) |> 
  filter(insitu == 0) |> 
  mutate(across(all_of(c(factors1, tc, trt)), factor))

# Then run the analysis
cox0 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors1,
                   covariates = NULL,
                   group_var = "detection_mode")

# age adjusted
cox1 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors1,
                   covariates = covariate1,
                   group_var = "detection_mode")

# age and TC adjusted
cox2 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors1,
                   covariates = covariate2,
                   group_var = "detection_mode")

# age, TC and trt adjusted
cox3 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors1,
                   covariates = covariate3,
                   group_var = "detection_mode")
result1 <- cox0 |> 
  left_join(cox1, by = c("predictor_var","term","detection_mode"), suffix = c("","_age")) |> 
  left_join(cox2, by = c("predictor_var","term","detection_mode"), suffix = c("", "_tc")) |> 
  left_join(cox3, by = c("predictor_var","term","detection_mode"), suffix = c("", "_trt"))

temp1 <- result1[,c("predictor_var", "term", "detection_mode", "est_ci", "est_ci_age", "est_ci_tc","est_ci_trt")]
```

## cohort 2
```{r}
factors2 <- c("FH_BC_bl_40", "FH_BC_bl_50", "FH_BC_bl_median", "Breast_n_bi", "pd_BIRADs","bmi_cat", "hrt_ever","hrt_ever_reg","Alcohol_day", "smoking_packyears", "risk_breastcancer_own_5yr", "risk_breastcancer_own_10yr","risk_breastcancer_own_lifetime","GRS_BC", "protein_LOF_rare_variants_exonic", "pinkcat","BOADICEA") #pd_3group "masses_3cat","masses_dif_3cat","masses_dif", "smoking_status_dummy", "smoking_status_dummy2",

## as of Aug 3
factors2 <- c("FH_BC_bl_40", "FH_BC_bl_50", "FH_BC_bl_median", "Breast_n_bi", "pd_3group","pd_BIRADs","bmi_cat", "Alcohol_day", "smoking_packyears", "risk_breastcancer_own_10yr","GRS_BC", "protein_LOF_rare_variants_exonic", "pinkcat","BOADICEA")

# Convert columns to factors before analysis
cohort <- cohort2 |> 
 # filter(pd <= 40) |> 
  filter(M_stage != 1) |> 
  filter(insitu != 1) |> 
  mutate(
    #time_start = pmax(bc_diagdate, studyentry_date), #delayed entry to start from study entry date or diagnosis date, whichever came later
    time_start = bc_diagdate, #no delay entry, enter at diagnosis
    time_end = ymd("2022-05-07"),
    time_to_death = as.numeric(death_date - time_start),
    # time_to_emig = 
    #   case_when(
    #     emigration_date > time_start ~ as.numeric(emigration_date - time_start),
    #   TRUE ~ NA_real_),
    death_BC =  case_when(
      !is.na(death_date)  & substr(death_cause, 1,3) %in% c("C50", "174") ~ 1,
      #!is.na(death_date)  & substr(death_cause, 1,3) %in% c("C50", "170") & time_to_death <= 365*10 ~ 1, # 10-year mortality
      TRUE ~ 0),
    time_var = pmin(time_to_death, time_end - time_start, na.rm=T)) #365*10 time_to_emig, 
   


# Then run the analysis
cox0 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors2,
                   covariates = NULL,
                   group_var = "detection_mode")

# age adjusted
cox1 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors2,
                   covariates = covariate1,
                   group_var = "detection_mode")

# age and TC adjusted
cox2 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors2,
                   covariates = covariate2,
                   group_var = "detection_mode")
# age, TC and trt adjusted
cox3 <- coxph_loop(data = cohort, outcome_var = "death_BC", time_var = "time_var",
                   predictor_vars = factors2,
                   covariates = covariate3,
                   group_var = "detection_mode")

result2 <- cox0 |> 
  left_join(cox1, by = c("predictor_var","term","detection_mode"), suffix = c("","_age")) |> 
  left_join(cox2, by = c("predictor_var","term","detection_mode"), suffix = c("", "_tc")) |> 
  left_join(cox3, by = c("predictor_var","term","detection_mode"), suffix = c("", "_trt"))

View(result2[,c("predictor_var", "term", "detection_mode", "est_ci", "est_ci_age", "est_ci_tc","est_ci_trt")])
```

```{r}
result <- bind_rows(result1, result2) |> 
  mutate(order = 1:42) |> 
  arrange(detection_mode, order)

output <- result |> 
  select(detection_mode, predictor_var, term, est_ci_age, p.value_age, est_ci_tc, p.value_tc)

write_csv(output, "HR_detection_mode_factors.csv")
```


